---
import MainLayout from '../layouts/MainLayout.astro';
import { prisma } from '../lib/db';
import bcrypt from 'bcryptjs';

let errorMessage = "";

if (Astro.request.method === 'POST') {
  const data = await Astro.request.formData();
  const email = data.get('email') as string;
  const password = data.get('password') as string;

  // 1. Buscamos al usuario por email
  const user = await prisma.user.findUnique({ where: { email } });

  if (user) {
    // 2. Comparamos la contraseña encriptada
    const isValid = await bcrypt.compare(password, user.password);

    if (isValid) {
      // 3. GESTIÓN DE COOKIES (Requisito de Sesión)
      // Guardamos el nombre y el rol en una cookie segura
      Astro.cookies.set('user_name', user.nombre, { path: '/', httpOnly: true });
      Astro.cookies.set('user_role', user.role, { path: '/', httpOnly: true });

      return Astro.redirect('/');
    } else {
      errorMessage = "Contraseña incorrecta";
    }
  } else {
    errorMessage = "El usuario no existe";
  }
}
---

<MainLayout title="Acceso">
  <div style="max-width: 400px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h2>Identificarse</h2>
    
    {errorMessage && <p style="color: red; background: #fee; padding: 0.5rem; border-radius: 4px;">{errorMessage}</p>}

    <form method="POST" style="display: flex; flex-direction: column; gap: 1rem;">
      <label>
        Correo electrónico:
        <input type="email" name="email" required style="width: 100%; padding: 0.5rem;" />
      </label>
      <label>
        Contraseña:
        <input type="password" name="password" required style="width: 100%; padding: 0.5rem;" />
      </label>
      <button type="submit" style="background: var(--primary); color: white; padding: 0.8rem; border: none; border-radius: 4px; cursor: pointer;">
        Entrar
      </button>
    </form>
    
    <p style="margin-top: 1rem; font-size: 0.9rem;">
      ¿No tienes cuenta? <a href="/register">Regístrate aquí</a>
    </p>
  </div>
</MainLayout>