---
import MainLayout from "../layouts/MainLayout.astro";
import { prisma } from "../lib/db";

// 1. GESTI√ìN DE SESI√ìN
const userRole = Astro.cookies.get('user_role')?.value;
const userName = Astro.cookies.get('user_name')?.value;
const isAdmin = userRole === 'ADMIN';
const isLogged = !!userName; // True si hay un nombre de usuario en las cookies

// 2. L√ìGICA DE B√öSQUEDA
const search = Astro.url.searchParams.get("search") || "";
const animales = await prisma.animal.findMany({
  where: {
    OR: [
      { nombre: { contains: search } },
      { especie: { contains: search } },
    ]
  },
  orderBy: { createdAt: 'desc' }
});

// 3. USO DE .REDUCE (Para el resumen de especies)
const conteoEspecies = animales.reduce((acc, animal) => {
  if (animal.especie) {
    acc[animal.especie] = (acc[animal.especie] || 0) + 1;
  }
  return acc;
}, {} as Record<string, number>);

const especiesUnicas = Object.keys(conteoEspecies).length;
---

<MainLayout title="Cat√°logo de Fauna">
  <section style="margin-bottom: 2rem; text-align: center;">
    <h1>Explora nuestra Fauna</h1>
    
    {/* Buscador */}
    <form action="/" method="GET" style="max-width: 500px; margin: 0 auto 1.5rem; display: flex; gap: 10px;">
      <input 
        type="text" 
        name="search" 
        placeholder="Buscar animal o especie..." 
        value={search} 
        style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #ddd; outline: none;" 
      />
      <button type="submit" style="background: var(--primary); color: white; padding: 10px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
        Buscar
      </button>
    </form>

    {/* Resumen din√°mico con .reduce */}
    <div style="font-size: 0.9rem; color: #666; background: #fff; display: inline-block; padding: 0.5rem 1.5rem; border-radius: 20px; border: 1px solid #eee;">
      üìä <strong>{animales.length}</strong> animales registrados en <strong>{especiesUnicas}</strong> categor√≠as de especies.
    </div>
  </section>

  {/* Grid de Animales */}
  <div class="animal-grid">
    {animales.length > 0 ? (
      animales.map((animal) => (
        <div class="animal-card">
          <a href={`/animal/${animal.id}`} class="card-body">
            <div class="image-box">
               {animal.imagenUrl ? (
                 <img src={animal.imagenUrl} alt={animal.nombre} loading="lazy" />
               ) : (
                 <div class="no-img">üåø</div>
               )}
            </div>
            <div class="info-box">
              <h3>{animal.nombre}</h3>
              <p><i>{animal.especie}</i></p>
            </div>
          </a>

          {/* L√ìGICA DE BOTONES: Solo se muestran si es ADMIN */}
          {isAdmin && (
            <div class="card-actions">
              <a href={`/editar/${animal.id}`} class="btn-action btn-edit">
                <span>‚úèÔ∏è</span> Editar
              </a>
              <form 
                action={`/api/delete/${animal.id}`} 
                method="POST" 
                style="margin: 0;"
                onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar este registro?')"
              >
                <button type="submit" class="btn-action btn-delete">
                  <span>üóëÔ∏è</span> Borrar
                </button>
              </form>
            </div>
          )}
        </div>
      ))
    ) : (
      <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
        <p style="font-size: 1.2rem; color: #999;">No se encontraron animales con ese nombre.</p>
        <a href="/" style="color: var(--primary); text-decoration: underline;">Ver todos</a>
      </div>
    )}
  </div>
</MainLayout>

<style>
  .animal-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    gap: 2rem; 
  }
  .animal-card { 
    background: white; 
    border-radius: 15px; 
    overflow: hidden; 
    border: 1px solid #eee; 
    display: flex; 
    flex-direction: column; 
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .animal-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  .card-body { text-decoration: none; color: inherit; flex-grow: 1; }
  .image-box { height: 200px; background: #f0f0f0; overflow: hidden; }
  .image-box img { width: 100%; height: 100%; object-fit: cover; }
  .no-img { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
  .info-box { padding: 1.2rem; }
  .info-box h3 { margin: 0; color: var(--primary); font-size: 1.4rem; }
  .info-box p { margin: 5px 0 0; color: #666; }
  
  .card-actions { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    border-top: 1px solid #eee; 
    background: #fdfdfd; 
    gap: 1px; 
  }
  .btn-action { 
    background: transparent; 
    padding: 12px; 
    border: none; 
    font-weight: bold; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 5px;
    text-decoration: none; 
    font-size: 0.85rem; 
  }
  .btn-edit { color: #4361ee; border-right: 1px solid #eee; }
  .btn-delete { color: #e63946; width: 100%; }
  .btn-action:hover { background: #f0f0f0; }
</style>